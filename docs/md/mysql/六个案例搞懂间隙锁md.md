
æœ¬æ–‡å·²æ”¶å½•è‡³Githubï¼Œæ¨èé˜…è¯» ğŸ‘‰ [Javaéšæƒ³å½•](https://github.com/ZhengShuHai/JavaRecord)

å¾®ä¿¡å…¬ä¼—å·ï¼š[Javaéšæƒ³å½•](https://mmbiz.qpic.cn/mmbiz_jpg/jC8rtGdWScMuzzTENRgicfnr91C5Bg9QNgMZrxFGlGXnTlXIGAKfKAibKRGJ2QrWoVBXhxpibTQxptf8MsPTyHvSg/0?wx_fmt=jpeg)

[TOC]

MySQLä¸­çš„é—´éš™æ˜¯æŒ‡ç´¢å¼•ä¸­ä¸¤ä¸ªç´¢å¼•é”®ä¹‹é—´çš„ç©ºé—´ï¼Œé—´éš™é”ç”¨äºé˜²æ­¢èŒƒå›´æŸ¥è¯¢æœŸé—´çš„å¹»è¯»ï¼Œç¡®ä¿æŸ¥è¯¢ç»“æœçš„ä¸€è‡´æ€§å’Œå¹¶å‘å®‰å…¨æ€§ã€‚

## æ¦‚å¿µè§£é‡Š

**è®°å½•é”ï¼ˆRecord Lockï¼‰**

è®°å½•é”ä¹Ÿè¢«ç§°ä¸ºè¡Œé”ï¼Œé¡¾åæ€ä¹‰ï¼Œå®ƒæ˜¯é’ˆå¯¹æ•°æ®åº“ä¸­çš„è¡Œè®°å½•è¿›è¡Œçš„é”å®šã€‚

æ¯”å¦‚ï¼š

```sql
SELECT * FROM `user` WHERE `id`=1 FOR UPDATE;
```

ä¸Šé¢çš„SQLä¼šåœ¨ `id=1` çš„è¡Œè®°å½•ä¸ŠåŠ ä¸Šè®°å½•é”ï¼Œä»¥é˜»æ­¢å…¶ä»–äº‹åŠ¡æ’å…¥ï¼Œæ›´æ–°ï¼Œåˆ é™¤è¿™ä¸€è¡Œã€‚

**é—´éš™é”ï¼ˆGap Lockï¼‰**

é—´éš™é”å°±æ˜¯å¯¹é—´éš™åŠ é”ï¼Œç”¨äºé”å®šç´¢å¼•èŒƒå›´ä¹‹é—´çš„é—´éš™ï¼Œä»¥é¿å…å…¶ä»–äº‹åŠ¡åœ¨è¿™ä¸ªèŒƒå›´å†…æ’å…¥æ–°çš„æ•°æ®ã€‚é—´éš™é”æ˜¯æ’å®ƒé”ï¼Œé˜»æ­¢äº†å…¶ä»–äº‹åŠ¡åœ¨é—´éš™ä¸­æ’å…¥æ»¡è¶³æ¡ä»¶çš„å€¼ï¼Œé—´éš™é”ä»…åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹æ‰æœ‰æ•ˆã€‚

> å…³äºé—´éš™é”çš„è¯¦ç»†è®²è§£æ”¾åœ¨ä¸‹æ–‡ï¼Œè¿™é‡Œåªæ˜¯å…ˆåšä¸ªæ¦‚å¿µä¸Šçš„ä»‹ç»ã€‚

**ä¸´é”®é”ï¼ˆNext-Key Lockï¼‰**

ä¸´é”®é”ç”±è®°å½•é”å’Œé—´éš™é”ç»„åˆè€Œæˆï¼Œå®ƒåœ¨ç´¢å¼•èŒƒå›´å†…çš„è®°å½•ä¸ŠåŠ ä¸Šè®°å½•é”ï¼Œå¹¶åœ¨ç´¢å¼•èŒƒå›´ä¹‹é—´çš„é—´éš™ä¸ŠåŠ ä¸Šé—´éš™é”ã€‚è¿™æ ·å¯ä»¥é¿å…å¹»è¯»ï¼ˆPhantom Readï¼‰çš„é—®é¢˜ï¼Œç¡®ä¿äº‹åŠ¡çš„éš”ç¦»æ€§ã€‚

åˆ‡è®°ï¼šé—´éš™é”çš„åŒºé—´æ˜¯å·¦å¼€å³å¼€çš„ï¼Œä¸´é”®é”çš„åŒºé—´æ˜¯å·¦å¼€å³é—­çš„ã€‚

## é—´éš™é”è¯¦è§£

é—´éš™é”æ˜¯ä¿è¯ä¸´é”®é”æ­£å¸¸è¿ä½œçš„åŸºç¡€ï¼Œç†è§£é—´éš™é”çš„æ¦‚å¿µå¯¹äºæ·±å…¥ç†è§£è¿™ä¸‰ç§é”éå¸¸é‡è¦ã€‚

**é—´éš™é”çš„é”å®šèŒƒå›´æ˜¯æŒ‡åœ¨ç´¢å¼•èŒƒå›´ä¹‹é—´çš„é—´éš™**

ä¸¾ä¸ªç®€å•ä¾‹å­æ¥è¯´æ˜ï¼š

å‡è®¾æœ‰ä¸€ä¸ªåä¸º`products`çš„è¡¨ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªæ•´å‹åˆ—`product_id`ä½œä¸ºä¸»é”®ç´¢å¼•ã€‚ç°åœ¨æœ‰ä¸¤ä¸ªå¹¶å‘äº‹åŠ¡ï¼šäº‹åŠ¡Aå’Œäº‹åŠ¡Bã€‚

äº‹åŠ¡Aæ‰§è¡Œä»¥ä¸‹è¯­å¥ï¼š

```sql
BEGIN;
SELECT * FROM `products` WHERE `product_id` BETWEEN 100 and 200 FOR UPDATE;
```

äº‹åŠ¡Bæ‰§è¡Œä»¥ä¸‹è¯­å¥ï¼š

```sql
BEGIN;
INSERT INTO `products` (`product_id`, `name`) VALUES (150, 'Product 150');
```

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œäº‹åŠ¡Aä¼šåœ¨`products`è¡¨ä¸­`product_id`å€¼åœ¨ 100 å’Œ 200 ä¹‹é—´çš„èŒƒå›´ä¸Šè®¾ç½®é—´éš™é”ã€‚å› æ­¤ï¼Œåœ¨äº‹åŠ¡Aè¿è¡ŒæœŸé—´ï¼Œå…¶ä»–äº‹åŠ¡æ— æ³•åœ¨è¿™ä¸ªèŒƒå›´å†…æ’å…¥æ–°çš„æ•°æ®ï¼Œåœ¨äº‹åŠ¡Bå°è¯•æ’å…¥`product_id`ä¸º150çš„è®°å½•æ—¶ï¼Œç”±äºè¯¥è®°å½•ä½äºäº‹åŠ¡Aé”å®šçš„é—´éš™èŒƒå›´å†…ï¼Œäº‹åŠ¡Bå°†è¢«é˜»å¡ï¼Œç›´åˆ°äº‹åŠ¡Aé‡Šæ”¾é—´éš™é”ä¸ºæ­¢ã€‚

### é—´éš™é”è§¦å‘æ¡ä»¶

åœ¨å¯é‡å¤è¯»ï¼ˆRepeatable Readï¼‰äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸‹ï¼Œä»¥ä¸‹æƒ…å†µä¼šäº§ç”Ÿé—´éš™é”ï¼š

- ä½¿ç”¨æ™®é€šç´¢å¼•é”å®šï¼šå½“ä¸€ä¸ªäº‹åŠ¡ä½¿ç”¨æ™®é€šç´¢å¼•è¿›è¡Œæ¡ä»¶æŸ¥è¯¢æ—¶ï¼ŒMySQLä¼šåœ¨æ»¡è¶³æ¡ä»¶çš„ç´¢å¼•èŒƒå›´ä¹‹é—´çš„é—´éš™ä¸Šç”Ÿæˆé—´éš™é”ã€‚
- ä½¿ç”¨å¤šåˆ—å”¯ä¸€ç´¢å¼•ï¼šå¦‚æœä¸€ä¸ªè¡¨å­˜åœ¨å¤šåˆ—ç»„æˆçš„å”¯ä¸€ç´¢å¼•ï¼Œå¹¶ä¸”äº‹åŠ¡å¯¹è¿™äº›åˆ—è¿›è¡Œæ¡ä»¶æŸ¥è¯¢æ—¶ï¼ŒMySQLä¼šåœ¨æ»¡è¶³æ¡ä»¶çš„ç´¢å¼•èŒƒå›´ä¹‹é—´çš„é—´éš™ä¸Šç”Ÿæˆé—´éš™é”ã€‚
- ä½¿ç”¨å”¯ä¸€ç´¢å¼•é”å®šå¤šè¡Œè®°å½•ï¼šå½“ä¸€ä¸ªäº‹åŠ¡ä½¿ç”¨å”¯ä¸€ç´¢å¼•æ¥é”å®šå¤šè¡Œè®°å½•æ—¶ï¼ŒMySQLä¼šåœ¨è¿™äº›è®°å½•ä¹‹é—´çš„é—´éš™ä¸Šç”Ÿæˆé—´éš™é”ï¼Œä»¥ç¡®ä¿å…¶ä»–äº‹åŠ¡æ— æ³•åœ¨è¿™ä¸ªèŒƒå›´å†…æ’å…¥æ–°çš„æ•°æ®ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸Šè¿°æƒ…å†µä»…åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹æ‰ä¼šäº§ç”Ÿé—´éš™é”ã€‚åœ¨å…¶ä»–éš”ç¦»çº§åˆ«ä¸‹ï¼Œå¦‚è¯»æäº¤ï¼ˆRead Committedï¼‰éš”ç¦»çº§åˆ«ï¼ŒMySQLå¯èƒ½ä¼šä½¿ç”¨ä¸´æ—¶çš„æ„å‘é”æ¥é¿å…å¹¶å‘é—®é¢˜ï¼Œè€Œä¸æ˜¯ç”ŸæˆçœŸæ­£çš„é—´éš™é”ã€‚

ä¸ºä»€ä¹ˆè¿™é‡Œå¼ºè°ƒçš„æ˜¯æ™®é€šç´¢å¼•å‘¢ï¼Ÿå› ä¸ºå¯¹å”¯ä¸€ç´¢å¼•é”å®šå¹¶ä¸ä¼šè§¦å‘é—´éš™é”ï¼Œè¯·çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåä¸º`students`çš„è¡¨ï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªå­—æ®µï¼šid å’Œ nameã€‚idæ˜¯ä¸»é”®ï¼Œç°åœ¨æœ‰ä¸¤ä¸ªäº‹åŠ¡åŒæ—¶è¿›è¡Œæ“ä½œï¼š

äº‹åŠ¡Aæ‰§è¡Œä»¥ä¸‹è¯­å¥ï¼š

```sql
SELECT * FROM students WHERE id = 1 FOR UPDATE;
```

äº‹åŠ¡Bæ‰§è¡Œä»¥ä¸‹è¯­å¥ï¼š

```sql
INSERT INTO students (id, name) VALUES (2, 'John');
```

ç”±äºäº‹åŠ¡Aä½¿ç”¨äº†å”¯ä¸€ç´¢å¼•é”å®šï¼Œå®ƒä¼šé”å®šidä¸º1çš„è®°å½•ï¼Œä¸ä¼šè§¦å‘é—´éš™é”ã€‚åŒæ—¶ï¼Œåœ¨äº‹åŠ¡Bä¸­æ’å…¥idä¸º2çš„è®°å½•ä¹Ÿä¸ä¼šå—åˆ°å½±å“ã€‚è¿™æ˜¯å› ä¸ºå”¯ä¸€ç´¢å¼•åªä¼šé”å®šåŒ¹é…æ¡ä»¶çš„å…·ä½“è®°å½•ï¼Œè€Œä¸ä¼šé”å®šä¸å­˜åœ¨çš„è®°å½•ï¼ˆå¦‚é—´éš™ï¼‰ã€‚

**å½“ä½¿ç”¨å”¯ä¸€ç´¢å¼•é”å®šä¸€æ¡å­˜åœ¨çš„è®°å½•æ—¶ï¼Œä¼šä½¿ç”¨è®°å½•é”ï¼Œè€Œä¸æ˜¯é—´éš™é”**

ä½†æ˜¯å½“æœç´¢æ¡ä»¶ä»…æ¶‰åŠåˆ°å¤šåˆ—å”¯ä¸€ç´¢å¼•çš„ä¸€éƒ¨åˆ†åˆ—æ—¶ï¼Œå¯èƒ½ä¼šäº§ç”Ÿé—´éš™é”ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªä¾‹å­ï¼š

å‡è®¾`students`è¡¨ï¼ŒåŒ…å«ä¸‰ä¸ªåˆ—ï¼šidã€nameå’Œageã€‚æˆ‘ä»¬åœ¨(name, age)ä¸Šåˆ›å»ºäº†ä¸€ä¸ªå”¯ä¸€ç´¢å¼•ã€‚

ç°åœ¨æœ‰ä¸¤ä¸ªäº‹åŠ¡åŒæ—¶è¿›è¡Œæ“ä½œï¼š

äº‹åŠ¡Aæ‰§è¡Œä»¥ä¸‹è¯­å¥ï¼š

```sql
SELECT * FROM students WHERE name = 'John' FOR UPDATE;
```

äº‹åŠ¡Bæ‰§è¡Œä»¥ä¸‹è¯­å¥ï¼š

```sql
INSERT INTO students (id, name, age) VALUES (2, 'John', 25);
```

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œäº‹åŠ¡Aæœç´¢çš„æ¡ä»¶åªæ¶‰åŠåˆ°äº†å”¯ä¸€ç´¢å¼•çš„ä¸€éƒ¨åˆ†åˆ—ï¼ˆnameï¼‰ï¼Œè€Œæ²¡æœ‰æ¶‰åŠåˆ°å®Œæ•´çš„ç´¢å¼•åˆ—ï¼ˆname, ageï¼‰ã€‚å› æ­¤ï¼ŒMySQLä¼šå¯¹åŒ¹é…çš„è®°å½•åŠ ä¸Šè¡Œé”ï¼Œå¹¶ä¸”è¿˜ä¼šå¯¹ä¸è¯¥æ¡ä»¶èŒƒå›´ç›¸é‚»çš„é—´éš™åŠ ä¸Šé—´éš™é”ã€‚

### é—´éš™é”åŠ é”è§„åˆ™

é—´éš™é”æœ‰ä»¥ä¸‹åŠ é”è§„åˆ™ï¼š

- è§„åˆ™1ï¼šåŠ é”çš„åŸºæœ¬å•ä½æ˜¯ Next-Key Lockï¼Œå·¦å¼€å³é—­åŒºé—´ã€‚
- è§„åˆ™2ï¼šæŸ¥æ‰¾è¿‡ç¨‹ä¸­è®¿é—®åˆ°çš„å¯¹è±¡æ‰ä¼šåŠ é”ã€‚
- è§„åˆ™3ï¼šå”¯ä¸€ç´¢å¼•ä¸Šçš„èŒƒå›´æŸ¥è¯¢ä¼šä¸Šé”åˆ°ä¸æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€ä¸ªå€¼ä¸ºæ­¢ã€‚
- è§„åˆ™4ï¼šå”¯ä¸€ç´¢å¼•ç­‰å€¼æŸ¥è¯¢ï¼Œå¹¶ä¸”è®°å½•å­˜åœ¨ï¼ŒNext-Key Lock é€€åŒ–ä¸ºè¡Œé”ã€‚
- è§„åˆ™5ï¼šç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢ï¼Œä¼šå°†è·ç¦»æœ€è¿‘çš„å·¦è¾¹ç•Œå’Œå³è¾¹ç•Œä½œä¸ºé”å®šèŒƒå›´ï¼Œå¦‚æœç´¢å¼•ä¸æ˜¯å”¯ä¸€ç´¢å¼•è¿˜ä¼šç»§ç»­å‘å³åŒ¹é…ï¼Œç›´åˆ°é‡è§ç¬¬ä¸€ä¸ªä¸æ»¡è¶³æ¡ä»¶çš„å€¼ï¼Œå¦‚æœæœ€åä¸€ä¸ªå€¼ä¸ç­‰äºæŸ¥è¯¢æ¡ä»¶ï¼ŒNext-Key Lock é€€åŒ–ä¸ºé—´éš™é”ã€‚

è®°ä½ä¸Šè¿°è¿™äº›è§„åˆ™ï¼Œè¿™äº›è§„åˆ™ä¸å¤ªå¥½ç†è§£ï¼Œæˆ‘ä»¬ä¸‹é¢é€šè¿‡æ¡ˆä¾‹æ¥è®²è§£ã€‚

### æ¡ˆä¾‹æ¼”ç¤º

ç¯å¢ƒï¼šMySQLï¼ŒInnoDBï¼ŒRRéš”ç¦»çº§åˆ«ã€‚

æ•°æ®è¡¨ï¼š

```sql
CREATE TABLE `user` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `age` int DEFAULT NULL,
  `name` varchar(32) DEFAULT NULL,
   PRIMARY KEY (`id`)
   KEY `age` (`age`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

æ•°æ®ï¼š

| id   | age  | name |
| ---- | ---- | ---- |
| 1    | 1    | å°æ˜ |
| 5    | 5    | å°ç‹ |
| 7    | 7    | å°å¼  |
| 11   | 11   | å°é™ˆ |

åœ¨è¿›è¡Œæµ‹è¯•ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ user è¡¨ä¸­å­˜åœ¨çš„éšè—é—´éš™ï¼š

- (-âˆ, 1]
- (1, 5]
- (5, 7]
- (7, 11]
- (11, +âˆ]

#### æ¡ˆä¾‹ä¸€ï¼šå”¯ä¸€ç´¢å¼•ç­‰å€¼é”å®šå­˜åœ¨çš„æ•°æ®

å¦‚ä¸‹æ˜¯äº‹åŠ¡Aå’Œäº‹åŠ¡Bæ‰§è¡Œçš„é¡ºåºï¼š

| æ—¶åˆ» | äº‹åŠ¡A                                       | äº‹åŠ¡B                                        |
| ---- | ------------------------------------------- | -------------------------------------------- |
| T1   | begin                                       | begin                                        |
| T2   | select * from user where  id = 5 for update |                                              |
| T3   |                                             | insert into user value(3,3,"å°é»‘") ---ä¸é˜»å¡ |
| T4   |                                             | insert into user value(6,6,"å°è“") ---ä¸é˜»å¡ |
| T5   | commit                                      | commit                                       |

æ ¹æ®è§„åˆ™4ï¼ŒåŠ çš„æ˜¯è®°å½•é”ï¼Œä¸ä¼šä½¿ç”¨é—´éš™é”ï¼Œæ‰€ä»¥åªä¼šé”å®š 5 è¿™ä¸€è¡Œè®°å½•ã€‚

#### æ¡ˆä¾‹äºŒï¼šç´¢å¼•ç­‰å€¼é”å®š

| æ—¶åˆ» | äº‹åŠ¡A                                                        | äº‹åŠ¡B                                           |
| ---- | ------------------------------------------------------------ | ----------------------------------------------- |
| T1   | begin                                                        | begin                                           |
| T2   | select * from user where  id = 3 for update  ---  ä¸å­˜åœ¨çš„æ•°æ® |                                                 |
| T3   |                                                              | insert into user value(6,6,"å°è“")   --- ä¸é˜»å¡ |
| T4   |                                                              | insert into user value(2,2,"å°é»„")   --- é˜»å¡   |
| T5   | commit                                                       |                                                 |


è¿™æ˜¯ä¸€ä¸ªç´¢å¼•ç­‰å€¼æŸ¥è¯¢ï¼Œæ ¹æ®è§„åˆ™1å’Œè§„åˆ™5ï¼ŒåŠ é”èŒƒå›´æ˜¯ï¼ˆ 1ï¼Œ5 ] ï¼Œåˆç”±äºå‘å³éå†æ—¶æœ€åä¸€ä¸ªå€¼ 5 ä¸æ»¡è¶³æŸ¥è¯¢éœ€æ±‚ï¼ŒNext-Key Lock é€€åŒ–ä¸ºé—´éš™é”ã€‚ä¹Ÿå°±æ˜¯æœ€ç»ˆé”å®šèŒƒå›´åŒºé—´æ˜¯ ï¼ˆ 1ï¼Œ5 ï¼‰ã€‚

#### æ¡ˆä¾‹ä¸‰ï¼šå”¯ä¸€ç´¢å¼•èŒƒå›´é”å®š

| æ—¶åˆ» | äº‹åŠ¡A                                                 | äº‹åŠ¡B                                         |
| ---- | ----------------------------------------------------- | --------------------------------------------- |
| T1   | begin                                                 | begin                                         |
| T2   | select * from user where  id >= 5 and id<6 for update |                                               |
| T3   |                                                       | insert into user value(7,7,"å°èµµ")   --- é˜»å¡ |
| T4   | commit                                                |                                               |

æ ¹æ®è§„åˆ™3ï¼Œä¼šä¸Šé”åˆ°ä¸æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€ä¸ªå€¼ä¸ºæ­¢ï¼Œä¹Ÿå°±æ˜¯7ï¼Œæ‰€ä»¥æœ€ç»ˆåŠ é”èŒƒå›´æ˜¯  [ 5ï¼Œ7 ]ã€‚

å…¶å®è¿™é‡Œå¯ä»¥åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼Œç¬¬ä¸€æ¬¡ç”¨ id=5 å®šä½è®°å½•çš„æ—¶å€™ï¼Œå…¶å®åŠ ä¸Šäº†é—´éš™é” ï¼ˆ 1ï¼Œ5 ]ï¼Œåˆå› ä¸ºæ˜¯å”¯ä¸€ç´¢å¼•ç­‰å€¼æŸ¥è¯¢ï¼Œæ‰€ä»¥é€€åŒ–ä¸ºäº†è¡Œé”ï¼Œåªé”å®š 5ã€‚

ç¬¬äºŒæ¬¡ç”¨  id<6 å®šä½è®°å½•çš„æ—¶å€™ï¼Œå…¶å®åŠ ä¸Šäº†é—´éš™é”ï¼ˆ 5ï¼Œ7 ]ï¼Œæ‰€ä»¥æœ€ç»ˆåˆèµ·æ¥é”å®šåŒºé—´æ˜¯  [ 5ï¼Œ7 ]ã€‚

#### æ¡ˆä¾‹å››ï¼šéå”¯ä¸€ç´¢å¼•èŒƒå›´é”å®š

| æ—¶åˆ» | äº‹åŠ¡A                                                   | äº‹åŠ¡B                                           |
| ---- | ------------------------------------------------------- | ----------------------------------------------- |
| T1   | begin                                                   | begin                                           |
| T2   | select * from user where age >= 5 and  age<6 for update |                                                 |
| T3   |                                                         | insert into user value(8,8,"å°é’")   --- ä¸é˜»å¡ |
| T4   |                                                         | insert into user value(2,2,"å°é»„")   --- é˜»å¡   |
| T5   | commit                                                  |                                                 |

å‚è€ƒä¸Šé¢é‚£ä¸ªä¾‹å­ã€‚

ç¬¬ä¸€æ¬¡ç”¨ age =5 å®šä½è®°å½•çš„æ—¶å€™ï¼ŒåŠ ä¸Šäº†é—´éš™é” ï¼ˆ 1ï¼Œ5 ]ï¼Œä¸æ˜¯å”¯ä¸€ç´¢å¼•ï¼Œæ‰€ä»¥ä¸ä¼šé€€åŒ–ä¸ºè¡Œé”ï¼Œæ ¹æ®è§„åˆ™5ï¼Œä¼šç»§ç»­å‘å³åŒ¹é…ï¼Œæ‰€ä»¥æœ€ç»ˆåˆèµ·æ¥é”å®šåŒºé—´æ˜¯ ï¼ˆ 1ï¼Œ7 ]ã€‚

#### æ¡ˆä¾‹äº”ï¼šé—´éš™é”æ­»é”

| æ—¶åˆ» | äº‹åŠ¡A                                        | äº‹åŠ¡B                                         |
| ---- | -------------------------------------------- | --------------------------------------------- |
| T1   | begin                                        | begin                                         |
| T2   | select * from user where  id = 3 for update  |                                               |
| T3   |                                              | select * from user where  id = 4 for update   |
| T4   |                                              | insert into user value(2,2,"å°é»„")   --- é˜»å¡ |
| T5   | insert into user value(4,4,"å°ç´«") ---  é˜»å¡ |                                               |

é—´éš™é”ä¹‹é—´ä¸æ˜¯äº’æ–¥çš„ï¼Œå¦‚æœä¸€ä¸ªäº‹åŠ¡Aè·å–åˆ°äº†ï¼ˆ 1,5 ]  ä¹‹é—´çš„é—´éš™é”ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡Bä»ç„¶å¯ä»¥è·å–åˆ°ï¼ˆ 1,5 ]  ä¹‹é—´çš„é—´éš™é”ã€‚è¿™æ—¶å°±å¯èƒ½ä¼šå‘ç”Ÿæ­»é”é—®é¢˜ã€‚

åœ¨äº‹åŠ¡Aäº‹åŠ¡æäº¤ï¼Œé—´éš™é”é‡Šæ”¾ä¹‹å‰ï¼Œäº‹åŠ¡Bä¹Ÿè·å–åˆ°äº†é—´éš™é”ï¼ˆ 1,5 ] ï¼Œè¿™æ—¶ä¸¤ä¸ªäº‹åŠ¡å°±å¤„äºæ­»é”çŠ¶æ€ã€‚

#### æ¡ˆä¾‹å…­ï¼šlimitå¯¹åŠ é”çš„å½±å“

| æ—¶åˆ» | äº‹åŠ¡A                               | äº‹åŠ¡B                                           |
| ---- | ----------------------------------- | ----------------------------------------------- |
| T1   | begin                               | begin                                           |
| T2   | deletet  user where  age = 6 limt 1 |                                                 |
| T3   |                                     | insert into user value(7,7,"å°èµµ")   --- ä¸é˜»å¡ |
| T4   |                                     |                                                 |
| T5   | commit                              | commit                                          |

æ ¹æ®è§„åˆ™5ï¼Œé”å®šåŒºé—´åº”è¯¥æ˜¯ ( 5ï¼Œ7 ]ï¼Œä½†æ˜¯å› ä¸ºåŠ äº† limit 1 çš„é™åˆ¶ï¼Œå› æ­¤åœ¨éå†åˆ° age=6 è¿™ä¸€è¡Œä¹‹åï¼Œå¾ªç¯å°±ç»“æŸäº†ã€‚

æ ¹æ®è§„åˆ™2ï¼ŒæŸ¥æ‰¾è¿‡ç¨‹ä¸­è®¿é—®åˆ°çš„å¯¹è±¡æ‰ä¼šåŠ é”ï¼Œæ‰€ä»¥æœ€ç»ˆé”å®šåŒºé—´åº”è¯¥æ˜¯ï¼š( 5ï¼Œ6 ]ã€‚

## æ€»ç»“

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬è®¨è®ºäº†é—´éš™é”çš„åŠ é”è§„åˆ™ã€‚é—´éš™é”æ˜¯MySQLä¸­ç”¨äºä¿æŠ¤èŒƒå›´æŸ¥è¯¢å’Œé˜²æ­¢å¹¶å‘é—®é¢˜çš„é‡è¦æœºåˆ¶ï¼Œäº†è§£é—´éš™é”çš„åŠ é”è§„åˆ™å¯¹äºä¼˜åŒ–æ•°æ®åº“æ€§èƒ½ã€å‡å°‘æ•°æ®å†²çªä»¥åŠæé«˜å¹¶å‘æ€§èƒ½éå¸¸é‡è¦ã€‚

å¸Œæœ›æœ¬æ–‡èƒ½å¤Ÿå¸®åŠ©æ‚¨æ·±å…¥äº†è§£å’Œåº”ç”¨é—´éš™é”ï¼Œå¹¶ä¸ºæ‚¨çš„æ•°æ®åº“å¼€å‘å’Œä¼˜åŒ–å·¥ä½œæä¾›ä¸€äº›æŒ‡å¯¼å’Œå¯ç¤ºã€‚å¦‚æœæ‚¨æœ‰ä»»ä½•ç–‘é—®æˆ–éœ€è¦è¿›ä¸€æ­¥è®¨è®ºï¼Œæ¬¢è¿éšæ—¶ä¸æˆ‘ä»¬è”ç³»ã€‚